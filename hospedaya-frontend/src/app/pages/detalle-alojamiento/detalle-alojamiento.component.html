<app-header></app-header>
<div style="padding: 12px 16px;">
  <a routerLink="/dashboard" class="btn btn-primary">Volver al dashboard</a>
</div>
<!-- Detalle de Alojamiento -->
<section class="listing-detail" *ngIf="!loading && !error; else estado">
  <!-- Galer√≠a -->
  <div class="gallery" *ngIf="alojamiento as a">
    <figure class="gallery__main">
      <img [src]="resolverImg(a.imagenes && a.imagenes[0])"
           alt="Foto principal del alojamiento"
           class="clickable-image"
           (click)="openImage(a.imagenes && a.imagenes[0])" />
    </figure>
    <div class="gallery__thumbs" *ngIf="a.imagenes && a.imagenes.length > 1">
      <img *ngFor="let img of a.imagenes.slice(1,5)"
           [src]="resolverImg(img)"
           alt="Imagen del alojamiento"
           class="clickable-image"
           (click)="openImage(img)" />
    </div>
  </div>

  <!-- T√≠tulo + meta -->
  <header class="listing-header" *ngIf="alojamiento as a">
    <h1 class="listing-title">{{ a.titulo }}</h1>
    <div class="listing-meta">
      <span class="meta-item">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 22s7-5.686 7-12a7 7 0 1 0-14 0c0 6.314 7 12 7 12Z" stroke="currentColor" stroke-width="1.6"/><circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.6"/></svg>
        {{ a.direccion }}
      </span>
      <span class="meta-item rating">
        <span class="stars" aria-label="{{ avgRating || 0 }} de 5">
          <ng-container *ngFor="let i of [1,2,3,4,5]">
            <svg viewBox="0 0 20 20" width="16" height="16" [attr.fill]="i <= round(avgRating) ? '#f59e0b' : '#e5e7eb'" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.464c.969 0 1.371 1.24.588 1.81l-2.803 2.036a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.803-2.036a1 1 0 0 0-1.176 0l-2.803 2.036c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.977 8.72c-.783-.57-.38-1.81.588-1.81H7.03a1 1 0 0 0 .95-.69l1.07-3.292Z"/></svg>
          </ng-container>
        </span>
        <span class="rating-text" *ngIf="comentarios.length > 0; else sinResenas">
          {{ avgRating || 0 }} <span class="reviews">({{ comentarios.length }} rese√±a(s))</span>
        </span>
        <ng-template #sinResenas>
          <span class="rating-text">Sin rese√±as</span>
        </ng-template>
      </span>
    </div>
  </header>

  <div class="content" *ngIf="alojamiento as a">
    <!-- Columna izquierda -->
    <div class="left">
      <section class="card">
        <h2>Descripci√≥n</h2>
        <p>
          {{ a.descripcion }}
        </p>
        <ul class="facts">
          <li>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 10a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v7H3v-7Z" stroke="currentColor" stroke-width="1.6"/><path d="M7 8V7a5 5 0 0 1 10 0v1" stroke="currentColor" stroke-width="1.6"/></svg>
            Alojamiento completo
          </li>
          <li>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 20v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="1.6"/><circle cx="12" cy="7" r="3" stroke="currentColor" stroke-width="1.6"/></svg>
            Hu√©spedes: 4+
          </li>
          <li>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 20V7l8-4 8 4v13" stroke="currentColor" stroke-width="1.6"/><path d="M9 20v-6h6v6" stroke="currentColor" stroke-width="1.6"/></svg>
            Habitaciones: 2+
          </li>
          <li>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 11h10M6 15h12M9 7h6" stroke="currentColor" stroke-width="1.6"/></svg>
            Ba√±os: 1+
          </li>
        </ul>
      </section>

      <section class="card" *ngIf="a.servicios as ss">
        <h3>Servicios incluidos</h3>
        <ng-container *ngIf="ss.length > 0; else sinServicios">
          <ul class="services">
            <li *ngFor="let s of ss"><span class="check"></span> {{ s }}</li>
          </ul>
        </ng-container>
        <ng-template #sinServicios>
          <p class="hint">Este alojamiento no declar√≥ servicios.</p>
        </ng-template>
      </section>

      <section class="card">
        <h3>Calificaciones y comentarios</h3>
        <div class="rating-summary">
          <span class="stars" aria-label="{{avgRating}} de 5">
            <ng-container *ngFor="let i of [1,2,3,4,5]">
              <svg viewBox="0 0 20 20" width="18" height="18" [attr.fill]="i <= round(avgRating) ? '#f59e0b' : '#e5e7eb'" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.464c.969 0 1.371 1.24.588 1.81l-2.803 2.036a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.803-2.036a1 1 0 0 0-1.176 0l-2.803 2.036c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.977 8.72c-.783-.57-.38-1.81.588-1.81H7.03a1 1 0 0 0 .95-.69l1.07-3.292Z"/></svg>
            </ng-container>
          </span>
          <span class="rating-text">{{ avgRating || 0 }} / 5 ‚Ä¢ {{ comentarios.length }} rese√±a(s)</span>
        </div>

        <div class="comment-form" *ngIf="canComment(); else loginMsg">
          <label>Tu calificaci√≥n</label>
          <div class="stars-input">
            <label *ngFor="let i of [5,4,3,2,1]">
              <input type="radio" name="rating" [value]="i" [(ngModel)]="newComment.calificacion">
              <span>{{i}}‚òÖ</span>
            </label>
          </div>
          <label>Tu comentario</label>
          <textarea rows="3" [(ngModel)]="newComment.texto" placeholder="Escribe tu experiencia..."></textarea>
          <button class="btn" [disabled]="posting || !newComment.texto.trim()" (click)="enviarComentario()">Publicar</button>
        </div>
        <ng-template #loginMsg>
          <p class="hint">Debes iniciar sesi√≥n para comentar. <a routerLink="/login">Inicia sesi√≥n</a></p>
        </ng-template>

        <ul class="comments" *ngIf="comentarios.length > 0; else noComments">
          <li *ngFor="let c of comentarios" class="comment">
            <div class="comment-header">
              <span class="score">{{ c.calificacion }}‚òÖ</span>
            </div>
            <p class="comment-text">{{ c.texto }}</p>
          </li>
        </ul>
        <ng-template #noComments>
          <p class="hint">A√∫n no hay comentarios.</p>
        </ng-template>
      </section>

      <!-- Secci√≥n del mapa -->
      <section class="card" *ngIf="a.latitud != null && a.longitud != null">
        <h3>Ubicaci√≥n</h3>
        <p class="location-info">üìç {{ a.direccion }}</p>
        <div id="map-detalle" class="map-detalle"></div>
      </section>

    </div>

    <!-- Columna derecha -->
    <aside class="right">
      <div class="booking card">
        <div class="price">
          <span class="amount">{{ a.precioPorNoche | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          <span class="per">/ noche</span>
        </div>
        <div class="availability">
          <h4>Disponibilidad</h4>
          <div class="dates">
            <div class="date">
              <label class="label" for="checkin">Check-in</label>
              <input id="checkin" type="date" [min]="today()" [(ngModel)]="checkIn" (ngModelChange)="onCheckInChange($event)" />
            </div>
            <div class="date">
              <label class="label" for="checkout">Check-out</label>
              <input id="checkout" type="date" [min]="minCheckout()" [(ngModel)]="checkOut" />
            </div>
          </div>
        </div>
        <button class="reserve-btn" type="button"
                [routerLink]="['/alojamientos', a.id, 'reservar']"
                [queryParams]="{ fechaInicio: checkIn || null, fechaFin: checkOut || null }">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Reservar ahora
        </button>
        <p class="disclaimer">No se cobrar√° nada todav√≠a</p>
      </div>
    </aside>
  </div>
</section>

<!-- Modal / visor de imagen ampliada -->
<div class="image-modal" *ngIf="selectedImageUrl" (click)="closeImage()">
  <div class="image-modal__backdrop"></div>
  <img class="image-modal__img" [src]="selectedImageUrl" alt="Imagen ampliada del alojamiento" (click)="$event.stopPropagation()" />
  <button type="button" class="image-modal__close" (click)="closeImage(); $event.stopPropagation()">√ó</button>
</div>

<ng-template #estado>
  <div class="listing-detail">
    <p *ngIf="loading">Cargando alojamiento...</p>
    <div *ngIf="error" class="card" style="border-color:#fecaca; background:#fff1f2;">
      <p>{{ error }}</p>
      <a routerLink="/" style="color:#be123c; font-weight:600;">Volver al inicio</a>
    </div>
  </div>
</ng-template>
