<app-header></app-header>

<main class="container">
  <section class="welcome">
    <h2>Bienvenido, {{ user?.nombre || 'Anfitri√≥n' }}</h2>
    <p>Aqu√≠ encontrar√°s un resumen de tus alojamientos y reservas recibidas.</p>
  </section>

  <section class="metrics">
    <div class="card">
      <p class="label">Total de Alojamientos</p>
      <div class="value">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9M5 10v10h4v-6h6v6h4V10" />
        </svg>
        <span>{{ totalAlojamientos }}</span>
      </div>
    </div>

    <div class="card">
      <p class="label">Reservas Activas</p>
      <div class="value">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14V7H5v14z" />
        </svg>
        <span>{{ reservasActivas }}</span>
      </div>
    </div>

    <div class="card">
      <p class="label">Ganancias Estimadas</p>
      <div class="value">
        <span>{{ gananciasEstimadas | currency:'USD':'symbol':'1.0-0' }}</span>
      </div>
    </div>

    <div class="card">
      <p class="label">Valoraci√≥n Promedio</p>
      <div class="value">
        <span>{{ valoracionPromedio }}</span>
        <span class="label" style="margin-left:8px; font-weight:400;">({{ totalResenas }} rese√±a(s))</span>
      </div>
    </div>
  </section>

  <section class="listado">
    <div class="listado-header">
      <h3>Mis Alojamientos</h3>
      <button class="btn-agregar" (click)="irANuevo()">+ Agregar Alojamiento</button>
    </div>

    <!-- Estados de carga y error -->
    <div *ngIf="cargando" class="card" style="padding:16px;">Cargando...</div>
    <div *ngIf="!cargando && error" class="card" style="padding:16px; color:#b91c1c;">{{ error }}</div>

    <!-- Listado -->
    <div class="alojamientos" *ngIf="!cargando && !error">
      <div *ngIf="alojamientos.length === 0" class="card" style="padding:16px;">A√∫n no tienes alojamientos. ¬°Crea el primero!</div>

      <div class="alojamiento" *ngFor="let a of alojamientos">
        <img [src]="a.imagenes && a.imagenes.length ? a.imagenes[0] : 'https://placehold.co/600x400/9333ea/ffffff?text=' + (a.titulo || 'ALOJAMIENTO')" [alt]="a.titulo">
        <div class="info">
          <h4>{{ a.titulo }}</h4>
          <p class="ubicacion">{{ a.direccion }}</p>
          <div class="detalle">
            <p class="precio">{{ a.precioPorNoche | currency:'USD':'symbol' }} <span>/noche</span></p>
            <p class="valoracion">‚òÖ {{ ratings[a.id]?.avg || 0 }} ({{ ratings[a.id]?.count || 0 }})</p>
          </div>
          <button class="btn-detalle" (click)="verDetalle(a)">Ver detalles</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Reservas recibidas -->
  <section class="listado" style="margin-top:24px;">
    <div class="listado-header">
      <h3>Reservas recibidas</h3>
      <button class="btn-agregar" (click)="irAGestion()">Gestionar alojamientos</button>
    </div>

    <div *ngIf="cargandoReservas" class="card" style="padding:16px;">Cargando reservas...</div>
    <div *ngIf="!cargandoReservas && errorReservas" class="card" style="padding:16px; color:#b91c1c;">{{ errorReservas }}</div>

    <div class="alojamientos" *ngIf="!cargandoReservas && !errorReservas">
      <div *ngIf="reservas.length === 0" class="card" style="padding:16px;">A√∫n no tienes reservas en tus alojamientos.</div>

      <div class="alojamiento" *ngFor="let r of reservas">
        <ng-container *ngIf="alojamientoDeReserva(r) as a">
          <img [src]="resolverImg(a)" [alt]="a.titulo">
          <div class="info">
            <h4>{{ a.titulo }}</h4>
            <p class="ubicacion">üìç {{ a.direccion }}</p>
            <div class="detalle">
              <p class="precio">{{ a.precioPorNoche | currency:'USD':'symbol' }} <span>/noche</span></p>
              <p class="valoracion">Reserva: {{ r.fechaInicio }} ‚Üí {{ r.fechaFin }}</p>
            </div>
            <span class="badge" [ngClass]="{
              'en-curso': estadoVisual(r) === 'EN CURSO',
              'terminada': estadoVisual(r) === 'TERMINADA',
              'pendiente': estadoVisual(r) === 'PENDIENTE'
            }" style="padding:4px 8px; border-radius:6px; font-size:12px;">{{ estadoVisual(r) }}</span>
          </div>
        </ng-container>
      </div>
    </div>
  </section>

  <!-- Rese√±as recibidas -->
  <section class="listado" style="margin-top:24px;">
    <div class="listado-header">
      <h3>Rese√±as recibidas</h3>
    </div>

    <div *ngIf="cargandoResenas" class="card" style="padding:16px;">Cargando rese√±as...</div>
    <div *ngIf="!cargandoResenas && errorResenas" class="card" style="padding:16px; color:#b91c1c;">{{ errorResenas }}</div>

      <div class="alojamientos" *ngIf="!cargandoResenas && !errorResenas">
      <div *ngIf="resenas.length === 0" class="card" style="padding:16px;">A√∫n no has recibido rese√±as.</div>

      <div class="alojamiento" *ngFor="let c of resenas">
        <div class="info">
          <h4>‚òÖ {{ c.calificacion }} ‚Äî {{ c.alojamientoNombre || ('Alojamiento #' + c.alojamientoId) }}</h4>
          <p class="ubicacion">{{ c.usuarioNombre || ('Usuario #' + c.usuarioId) }}</p>
          <div class="detalle">
            <p class="valoracion" style="margin:0;">‚Äú{{ c.texto }}‚Äù</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
