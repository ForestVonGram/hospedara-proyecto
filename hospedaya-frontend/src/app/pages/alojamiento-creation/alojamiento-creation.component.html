<app-header [variant]="'host'"></app-header>

<!-- MAIN CONTENT -->
<main class="container nuevo-alojamiento">
  <h2 class="page-title">{{ isEdit ? 'Editar Alojamiento' : 'Nuevo Alojamiento' }}<span class="beta-badge" *ngIf="!isEdit">beta</span></h2>
  <p class="page-sub">{{ isEdit ? 'Actualiza la información de tu propiedad' : 'Completa la información de tu propiedad' }}</p>

  <!-- Subida de Fotos -->
  <section class="card upload-section">
    <h3 class="section-title">
      <span class="section-icon" aria-hidden="true">
        <!-- camera icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 3l-2 2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2h-2l-2-2H9z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.6" fill="none"/>
        </svg>
      </span>
      Subida de Fotos
    </h3>
    <div class="upload-box" id="dropzone" tabindex="0" role="button">
      <div class="upload-icon" aria-hidden="true">
        <!-- cloud upload icon -->
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 18h10a4 4 0 000-8 5.5 5.5 0 00-10.4-2.2A4 4 0 007 18z" stroke="#7c3aed" stroke-width="1.6" fill="none"/>
          <path d="M12 14v-5" stroke="#7c3aed" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M9.5 10.5L12 8l2.5 2.5" stroke="#7c3aed" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <p class="upload-copy">Sube archivos o pega URLs (ahora el backend usa Cloudinary)</p>
      <div class="upload-controls" style="display:flex; gap:8px; flex-wrap: wrap; align-items:center;">
        <input type="file" accept="image/*" (change)="onFileSelected($event)" />
        <button class="btn btn-primary" type="button" (click)="uploadSelectedImage()" [disabled]="!selectedFile">Subir archivo</button>
        <span *ngIf="uploadProgress > 0 && uploadProgress < 100">Subiendo: {{uploadProgress}}%</span>
        <div style="flex:1"></div>
        <input type="url" placeholder="https://..." [(ngModel)]="nuevaImagenUrl" name="nuevaImagenUrl" />
        <button class="btn btn-secondary" type="button" (click)="agregarImagenUrl()">Agregar URL</button>
      </div>
      <ul class="preview-list" *ngIf="imagenesList.length > 0">
        <li *ngFor="let item of imagenesList">
          <img [src]="item.url" alt="preview" style="width:80px;height:60px;object-fit:cover;border-radius:6px;margin-right:8px;" />
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:360px;">{{ item.url }}</span>
          <button type="button" class="btn" (click)="quitarImagen(item)">Quitar</button>
        </li>
      </ul>
    </div>
  </section>

  <!-- Formulario -->
  <section class="card form-section">
    <h3 class="section-title">
      <span class="section-icon" aria-hidden="true">
        <!-- form icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 4h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          <path d="M8 8h8M8 12h8M8 16h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </span>
      Formulario de Datos del Alojamiento
    </h3>

    <form class="alojamiento-form" [formGroup]="form" (ngSubmit)="onSubmit()">
      <label for="nombre">Nombre del alojamiento</label>
      <input id="nombre" type="text" placeholder="Ej: Casa de Playa Paradise" formControlName="nombre" />
      <small class="error" *ngIf="f['nombre'].touched && f['nombre'].invalid">El nombre es obligatorio</small>

      <label for="descripcion">Descripción</label>
      <textarea id="descripcion" rows="5" placeholder="Describe tu propiedad..." formControlName="descripcion"></textarea>
      <small class="error" *ngIf="f['descripcion'].touched && f['descripcion'].invalid">La descripción es obligatoria</small>

      <div class="form-row">
        <div class="form-group">
          <label for="direccion">Ubicación</label>
          <input id="direccion" type="text" placeholder="Ciudad, dirección" formControlName="direccion" />
          <small class="error" *ngIf="f['direccion'].touched && f['direccion'].invalid">La dirección es obligatoria</small>
        </div>

        <div class="form-group">
          <label for="precioPorNoche">Precio por noche</label>
          <input id="precioPorNoche" type="number" min="0" step="0.01" placeholder="$0.00" formControlName="precioPorNoche" />
          <small class="error" *ngIf="f['precioPorNoche'].touched && f['precioPorNoche'].invalid">Ingresa un precio válido</small>
        </div>

        <div class="form-group">
          <label for="maxHuespedes">Capacidad máxima de huéspedes</label>
          <input id="maxHuespedes" type="number" min="1" step="1" placeholder="Ej: 6" formControlName="maxHuespedes" />
          <small class="hint">Este valor limitará la cantidad de huéspedes al reservar.</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="habitaciones">Habitaciones</label>
          <input id="habitaciones" type="number" min="0" step="1" placeholder="0" formControlName="habitaciones" />
        </div>
        <div class="form-group">
          <label for="banos">Baños</label>
          <input id="banos" type="number" min="0" step="1" placeholder="0" formControlName="banos" />
        </div>
      </div>


      <!-- Ubicación en el mapa -->
      <div class="form-row">
        <div class="form-group" style="flex:1 1 100%">
          <label>Ubicación en el mapa</label>
          <app-mapbox-map
            [selectable]="true"
            [selectedLngLat]="selectedLngLat"
            (selectedLngLatChange)="onMapSelection($event)"
            [center]="selectedLngLat || [-74.0817, 4.6097]"
            [zoom]="selectedLngLat ? 14 : 10"
          >
            <app-marker *ngIf="selectedLngLat" [lng]="selectedLngLat[0]" [lat]="selectedLngLat[1]" popup="Ubicación seleccionada" color="#7c3aed" [scale]="1.2"></app-marker>
          </app-mapbox-map>
          <small class="hint">Haz clic en el mapa para establecer la ubicación exacta del alojamiento.</small>
          <div style="display:flex; gap:12px; margin-top:8px; align-items:center;">
            <label style="margin:0">Lat:</label>
            <input type="number" step="0.000001" [ngModel]="form.value.latitud" (ngModelChange)="form.patchValue({latitud: $event}); onManualCoordsChange()" name="latitud" [ngModelOptions]="{standalone: true}" style="max-width:180px">
            <label style="margin:0">Lng:</label>
            <input type="number" step="0.000001" [ngModel]="form.value.longitud" (ngModelChange)="form.patchValue({longitud: $event}); onManualCoordsChange()" name="longitud" [ngModelOptions]="{standalone: true}" style="max-width:180px">
          </div>
        </div>
      </div>

      <!-- Servicios del alojamiento -->
      <section class="card">
        <h3 class="section-title">
          <span class="section-icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </span>
          Servicios del alojamiento
        </h3>

        <div class="servicios-grid">
          <label class="servicio-item" *ngFor="let s of servicios">
            <input type="checkbox" [checked]="selectedServicios.has(s.id)" (change)="toggleServicio(s.id, $event.target.checked)" />
            <span class="nombre">{{ s.nombre }}</span>
            <small class="desc" *ngIf="s.descripcion">{{ s.descripcion }}</small>
          </label>
          <p *ngIf="servicios.length === 0" class="hint">No hay servicios registrados aún.</p>
        </div>

        <div class="nuevo-servicio">
          <input type="text" placeholder="Nuevo servicio (p. ej. Piscina)" [(ngModel)]="nuevoServicioNombre" name="nuevoServicioNombre" [ngModelOptions]="{standalone: true}" />
          <input type="text" placeholder="Descripción (opcional)" [(ngModel)]="nuevoServicioDescripcion" name="nuevoServicioDescripcion" [ngModelOptions]="{standalone: true}" />
          <button type="button" class="btn btn-primary" (click)="crearServicio()" [disabled]="(nuevoServicioNombre || '').trim().length === 0">Agregar</button>
        </div>
      </section>

      <div class="messages">
        <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
        <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
      </div>

      <div class="actions">
        <button class="btn btn-primary publish-btn" type="submit" [disabled]="isSubmitting || form.invalid">
          {{ isSubmitting ? (isEdit ? 'Guardando...' : 'Publicando...') : (isEdit ? 'Guardar cambios' : 'Publicar alojamiento') }}
        </button>
      </div>
    </form>
  </section>
</main>
